# دليل إعداد صفحة تأكيد الطلب مع MyFatoorah

## نظرة عامة
تم إنشاء صفحة تأكيد الطلب التي تسمح للعملاء بتأكيد طلباتهم والدفع عبر بوابة الدفع MyFatoorah.

## الميزات المضافة

### 1. صفحة تأكيد الطلب (`/orders/create`)
- نموذج لإدخال بيانات العميل (الاسم، البريد الإلكتروني، الهاتف، العنوان)
- عرض تفاصيل الخدمة المطلوبة
- حساب المجموع بناءً على الكمية
- دمج بوابة الدفع MyFatoorah

### 2. صفحة تأكيد النجاح (`/orders/confirmation`)
- عرض تفاصيل الطلب بعد الدفع
- عرض حالة الدفع
- رسائل نجاح/فشل الدفع

### 3. دمج MyFatoorah
- إعدادات MyFatoorah في قاعدة البيانات
- معالجة استدعاءات الدفع
- معالجة أخطاء الدفع

## إعداد MyFatoorah

### 1. إعداد متغيرات البيئة
أضف المتغيرات التالية إلى ملف `.env`:

```env
# MyFatoorah Payment Gateway Settings
MYFATOORAH_API_KEY=your_myfatoorah_api_key_here
MYFATOORAH_TEST_MODE=true
MYFATOORAH_COUNTRY_ISO=SAU
```

### 2. إعداد قاعدة البيانات
قم بتشغيل الـ seeders لإضافة الإعدادات الافتراضية:

```bash
php artisan db:seed --class=SettingSeeder
```

### 3. إعداد MyFatoorah من لوحة الإدارة
1. اذهب إلى `/admin/myfatoorah/settings`
2. أدخل مفتاح API الخاص بك
3. اختر وضع الاختبار أو الإنتاج
4. اختر العملة (SAR للريال السعودي)

## تدفق العمل

### 1. اختيار الخدمة
- العميل يختار خدمة من صفحة الخدمات
- يضغط على زر "اطلب الآن"
- يتم توجيهه إلى صفحة تأكيد الطلب

### 2. تأكيد الطلب
- العميل يدخل بياناته الشخصية
- يختار الكمية المطلوبة
- يضغط على "تأكيد الطلب والدفع"

### 3. الدفع
- يتم إنشاء جلسة دفع مع MyFatoorah
- العميل يتم توجيهه إلى صفحة الدفع
- بعد الدفع، يتم توجيهه إلى صفحة التأكيد

### 4. التأكيد
- عرض تفاصيل الطلب
- عرض حالة الدفع
- رسالة شكر للعميل

## الملفات المضافة/المحدثة

### ملفات العرض (Views)
- `resources/views/orders/create.blade.php` - صفحة تأكيد الطلب
- `resources/views/orders/confirmation.blade.php` - صفحة تأكيد النجاح

### التحكمات (Controllers)
- `app/Http/Controllers/OrderController.php` - محدث لمعالجة الطلبات والدفع

### النماذج (Models)
- `app/Models/Order.php` - نموذج الطلبات
- `app/Models/Setting.php` - نموذج الإعدادات

### قاعدة البيانات
- `database/seeders/SettingSeeder.php` - إعدادات MyFatoorah الافتراضية

## اختبار النظام

### 1. اختبار وضع التطوير
```bash
# تشغيل الخادم
php artisan serve

# زيارة الموقع
http://127.0.0.1:8000
```

### 2. اختبار تدفق الطلب
1. اذهب إلى صفحة الخدمات
2. اختر خدمة واضغط "اطلب الآن"
3. أدخل بياناتك
4. اضغط "تأكيد الطلب والدفع"
5. اختبر الدفع (في وضع الاختبار)

### 3. اختبار لوحة الإدارة
1. اذهب إلى `/admin/myfatoorah`
2. تحقق من الإحصائيات
3. عرض المعاملات
4. إدارة الإعدادات

## استكشاف الأخطاء

### مشاكل شائعة

#### 1. خطأ في مفتاح API
```
يرجى إعداد مفتاح API لبوابة الدفع أولاً
```
**الحل:** تأكد من إدخال مفتاح API صحيح في الإعدادات

#### 2. فشل في الاتصال مع MyFatoorah
```
فشل في إنشاء جلسة الدفع
```
**الحل:** تحقق من اتصال الإنترنت وإعدادات MyFatoorah

#### 3. خطأ في معالجة الدفع
```
حدث خطأ في معالجة الدفع
```
**الحل:** تحقق من سجلات الأخطاء في `storage/logs/laravel.log`

## الأمان

### 1. تشفير البيانات
- جميع البيانات المالية مشفرة
- استخدام HTTPS في الإنتاج

### 2. التحقق من صحة البيانات
- التحقق من جميع المدخلات
- حماية من CSRF

### 3. سجلات الأمان
- تسجيل جميع محاولات الدفع
- مراقبة المعاملات المشبوهة

## الدعم الفني

للحصول على المساعدة:
1. تحقق من سجلات الأخطاء
2. راجع إعدادات MyFatoorah
3. تواصل مع فريق الدعم الفني

## التحديثات المستقبلية

### ميزات مخططة
- دعم عملات متعددة
- إشعارات البريد الإلكتروني
- تقارير مفصلة
- دعم المدفوعات المتكررة
